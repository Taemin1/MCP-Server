<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MCP Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        #logs { background: #000; padding: 20px; border-radius: 8px; margin-top: 20px; max-height: 500px; overflow-y: auto; }
        .log { margin-bottom: 5px; }
        .info { color: #4FC3F7; }
        .success { color: #81C784; }
        .error { color: #E57373; }
    </style>
</head>
<body>
<h1>MCP SSE Test Client</h1>
<input type="text" id="url" value="https://demeritorious-beverley-nonreadable.ngrok-free.dev" style="width:300px;padding:8px;">
<button onclick="connect()">ì—°ê²°</button>
<button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
<button onClick="goToV1()">ê¸°ì¡´ í˜ì´ì§€</button>
<div id="logs"></div>

<script>
    let eventSource = null;
    let sessionId = null;
    
    function goToV1() {
        window.location.href = 'index_v1.html';
    }

    function log(msg, type = 'info') {
        const logs = document.getElementById('logs');
        const div = document.createElement('div');
        div.className = `log ${type}`;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    async function sendMCP(method, params = {}) {
        if (!sessionId) {
            log('âŒ Session ID ì—†ìŒ', 'error');
            return;
        }

        const url = `${document.getElementById('url').value}/mcp/message?sessionId=${sessionId}`;
        const body = {
            jsonrpc: "2.0",
            method: method,
            ...(Object.keys(params).length > 0 && { params }),
            ...(method !== 'notifications/initialized' && { id: Date.now() })
        };

        log(`ğŸ“¤ ${method}`, 'info');

        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'mcp-protocol-version': '2024-11-05'
            },
            body: JSON.stringify(body)
        });

        log(`ğŸ“¨ ì‘ë‹µ: ${res.status}`, res.ok ? 'success' : 'error');
    }

    async function init() {
        await sendMCP('initialize', {
            protocolVersion: "2024-11-05",
            capabilities: {},
            clientInfo: { name: "Test", version: "1.0" }
        });
        await sendMCP('notifications/initialized');
        await sendMCP('tools/list');
    }

    function connect() {
        const base = document.getElementById('url').value;
        log(`ğŸ”„ ${base}/sse ì—°ê²° ì¤‘...`, 'info');

        eventSource = new EventSource(`${base}/sse`);

        eventSource.onopen = () => {
            log('âœ… SSE ì—°ê²° ì„±ê³µ', 'success');
        };

        eventSource.onmessage = (e) => {
            log(`ğŸ“¨ [message] ${e.data}`, 'info');
        };

        eventSource.addEventListener('endpoint', (e) => {
            log(`ğŸ”— [endpoint] ${e.data}`, 'info');

            // Session ID ì¶”ì¶œ
            const match = e.data.match(/sessionId=([a-f0-9-]+)/i);
            if (match) {
                sessionId = match[1];
                log(`ğŸ”‘ Session ID: ${sessionId}`, 'success');
                init();
            } else {
                log(`âš ï¸ Session ID ì¶”ì¶œ ì‹¤íŒ¨`, 'error');
            }
        });

        eventSource.addEventListener('message', (e) => {
            log(`ğŸ“¦ [message ì´ë²¤íŠ¸] ${e.data.substring(0, 200)}`, 'info');

            try {
                const data = JSON.parse(e.data);
                if (data.result && data.result.tools) {
                    log(`âœ… ë„êµ¬ ${data.result.tools.length}ê°œ ë°œê²¬!`, 'success');
                    data.result.tools.forEach(t => {
                        log(`  - ${t.name}: ${t.description}`, 'success');
                    });
                }
            } catch (err) {}
        });

        eventSource.onerror = () => {
            log('âŒ ì—°ê²° ì˜¤ë¥˜', 'error');
        };
    }

    function disconnect() {
        if (eventSource) {
            eventSource.close();
            sessionId = null;
            log('ğŸ”Œ ì—°ê²° ì¢…ë£Œ', 'info');
        }
    }

    log('ğŸ‰ ì¤€ë¹„ ì™„ë£Œ', 'success');
</script>
</body>
</html>