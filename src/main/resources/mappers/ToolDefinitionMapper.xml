<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.konantech.mcp.repository.ToolDefinitionRepository">

    <resultMap id="ToolDefinitionResultMap"
               type="com.konantech.mcp.model.ToolDefinition">
        <id property="id" column="id"/>
        <result property="name"          column="name"/>
        <result property="displayName"   column="display_name"/>
        <result property="description"   column="description"/>

        <result property="toolType"      column="tool_type"/>
        <result property="language"      column="language"/>
        <result property="definition"    column="definition"/>

        <result property="parameterSchema" column="parameter_schema"/>
        <result property="timeoutMs"     column="timeout_ms"/>
        <result property="enabled"       column="enabled"/>
        <result property="version"       column="version"/>

        <result property="createdAt"     column="created_at"/>
        <result property="updatedAt"     column="updated_at"/>
    </resultMap>

    <select id="selectByName" resultMap="ToolDefinitionResultMap">
        SELECT *
        FROM tool_definition
        WHERE name = #{name}
          AND enabled = TRUE
    </select>

    <select id="selectAllEnabled" resultMap="ToolDefinitionResultMap">
        SELECT *
        FROM tool_definition
        WHERE enabled = TRUE
        ORDER BY name
    </select>

    <insert id="insertToolDefinition" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tool_definition (
            name, display_name, description,
            tool_type, language, definition,
            parameter_schema, timeout_ms,
            enabled, version
        ) VALUES (
            #{name}, #{displayName}, #{description},
            #{toolType}, #{language}, #{definition},
            CAST(#{parameterSchema} AS jsonb), #{timeoutMs},
            #{enabled}, #{version}
        )
    </insert>

    <update id="updateToolDefinition">
        UPDATE tool_definition
        SET
            display_name     = #{displayName},
            description      = #{description},
            tool_type        = #{toolType},
            language         = #{language},
            definition       = #{definition},
            parameter_schema = CAST(#{parameterSchema} AS jsonb),
            timeout_ms       = #{timeoutMs},
            enabled          = #{enabled},
            version          = #{version},
            updated_at       = NOW()
        WHERE id = #{id}
    </update>

</mapper>
